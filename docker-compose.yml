version: "3"

services:
    client:
      container_name: client
      build:
        context: ./client
      volumes:
        - ./client:/app
        - /app/node_modules
      ports:
        - 3000:3000
      environment:
        - CHOKIDAR_USEPOLLING=true

    axigen:
      image: axigen/axigen
      env_file: .env
      volumes:
        - ./config/axigen:/var/opt/axigen
      ports:
        - 465:465
        - 993:993
        - 995:995
        - 7000:7000
        - 8080:8080
        - 9000:9000

    nginx:
      image: nginx:mainline
      restart: unless-stopped
      volumes:
        - ./config/nginx/prod.conf:/etc/nginx/nginx.conf
        - ./config/certbot/conf:/etc/letsencrypt
        - ./config/certbot/www:/var/www/certbot
      depends_on:
        - client
      ports:
        - 80:80
        - 443:443

    certbot:
      image: certbot/certbot
      restart: unless-stopped
      volumes:
        - ./config/certbot/conf:/etc/letsencrypt
        - ./config/certbot/www:/var/www/certbot
      entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
