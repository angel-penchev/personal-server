version: "3"

services:
    client:
        container_name: client
        build:
          context: ./client
        volumes:
          - './client:/app'
          - '/app/node_modules'
        ports:
          - 3000:3000
        environment:
          - CHOKIDAR_USEPOLLING=true

    nginx:
      image: nginx:stable
      restart: unless-stopped
      volumes:
        - ./config/nginx/prod.conf:/etc/nginx/conf.d/main.conf
        - ./config/certbot/conf:/etc/letsencrypt
        - ./config/certbot/www:/var/www/certbot
      depends_on:
        - client
      ports:
        - 80:80
        - 443:443
      command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"

    certbot:
      image: certbot/certbot
      restart: unless-stopped
      volumes:
        - ./config/certbot/conf:/etc/letsencrypt
        - ./config/certbot/www:/var/www/certbot
      entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
